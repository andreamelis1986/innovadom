<div class="dashboard-container">
  <!-- === SIDEBAR === -->
  <aside class="sidebar">
    <div *ngFor="let s of stats" class="stat-card">
      <div class="stat-icon">
        <i [ngClass]="{
          'fas fa-microchip': s.label === 'Totali',
          'fas fa-signal': s.label === 'Online',
          'fas fa-plug': s.label === 'Offline',
          'fas fa-lightbulb': s.label === 'Luci'
        }"></i>
      </div>

      <svg width="90" height="90" viewBox="0 0 100 100">
        <circle cx="50" cy="50" r="45" stroke="#1e293b" stroke-width="10" fill="none" />
        <circle cx="50" cy="50" r="45" stroke="#00e0ff" stroke-width="10" fill="none" stroke-linecap="round"
          [attr.stroke-dasharray]="2 * Math.PI * 45" [attr.stroke-dashoffset]="(2 * Math.PI * 45) - (s.perc * 2.8)"
          style="transition: stroke-dashoffset 0.6s ease" />
        <text x="50" y="55" text-anchor="middle" font-size="15" fill="#fff" font-weight="bold">
          {{ s.value }}
        </text>
      </svg>

      <h4>{{ s.label }}</h4>
      <p>{{ s.desc }}</p>
    </div>
  </aside>

  <!-- === AREA PRINCIPALE === -->
  <main class="content">
    <div class="top-actions">
      <h3>Gestione Dispositivi</h3>
      <button class="add-btn" (click)="openAddDeviceForm()">+ Aggiungi Dispositivo</button>
    </div>

    <div class="devices-grid">
      <div *ngFor="let d of devices()" class="device-card">
        <div class="card-header">
          <div class="card-header-left">
            <i [ngClass]="{
              'fa-solid fa-lightbulb': d.type === 'light',
              'fa-solid fa-temperature-three-quarters': d.type === 'climate',
              'fa-solid fa-video': d.type === 'camera',
              'fa-solid fa-window-maximize': d.type === 'shutter'
            }" class="device-icon"></i>

            <h4>{{ d.name || 'Senza nome' }}</h4>
          </div>

          <label class="toggle-switch">
            <input type="checkbox" [checked]="d.status === 'on'" (change)="toggleDevice(d)" />
            <span class="slider"></span>
          </label>
        </div>

        <p><strong>Tipo:</strong> {{ d.type }}</p>
        <p><strong>IP:</strong> {{ d.ip || '-' }}</p>
        <p><strong>Stato:</strong> <span [ngClass]="d.status">{{ d.status }}</span></p>

        <button *ngIf="d.id" (click)="deleteDevice(d.id!)" class="delete-btn">
          <i class="fa-solid fa-trash"></i> Elimina
        </button>
      </div>
    </div>
  </main>
</div>

<!-- === MODALE AGGIUNTA DISPOSITIVO === -->
<div *ngIf="showAddForm" class="add-device-overlay">
  <div class="add-device-modal">
    <h3>Nuovo Dispositivo</h3>
    <form (ngSubmit)="addDevice()" class="add-form">
      <input type="text" [(ngModel)]="newDevice.name" name="name" placeholder="Nome dispositivo" required />
      <select [(ngModel)]="newDevice.type" name="type">
        <option value="light">üí° Luce</option>
        <option value="climate">üå°Ô∏è Clima</option>
        <option value="camera">üìπ Telecamera</option>
        <option value="shutter">ü™ü Serranda</option>
      </select>
      <input type="text" [(ngModel)]="newDevice.ip" name="ip" placeholder="Indirizzo IP" required />
      <button type="submit" class="confirm-btn">Conferma</button>
      <button type="button" class="cancel-btn" (click)="closeAddDeviceForm()">Annulla</button>
    </form>

    <!-- ‚úÖ Mappa cliccabile -->
    <div class="map-container" (click)="selectPosition($event)">
      <img src="assets/planimetria_modern_5.png" alt="Mappa" class="map-image" />

      <!-- ‚úÖ Solo anteprima nuovo dispositivo -->
      <div class="device-icon preview"
           *ngIf="newDevice.top && newDevice.left"
           [style.top.%]="newDevice.top"
           [style.left.%]="newDevice.left">
        <i [ngClass]="{
          'fa-solid fa-lightbulb': newDevice.type === 'light',
          'fa-solid fa-temperature-high': newDevice.type === 'climate',
          'fa-solid fa-video': newDevice.type === 'camera',
          'fa-solid fa-window-maximize': newDevice.type === 'shutter'
        }"></i>
      </div>
    </div>
  </div>
</div>
