<div class="dashboard-container">
  <aside class="sidebar">
    <div class="info-card" *ngFor="let item of ['Luci','Temperatura','Energia','Telecamere']">
      <div class="card-header">
        <div class="icon-container"
          [style.background]="item === 'Luci' ? '#00bcd433' : item === 'Temperatura' ? '#ff980033' : item === 'Energia' ? '#4caf5033' : '#2196f333'">
          <i [class]="
            item === 'Luci' ? 'fas fa-lightbulb' :
            item === 'Temperatura' ? 'fas fa-temperature-high' :
            item === 'Energia' ? 'fas fa-bolt' :
            'fas fa-video'
          " [style.color]="
            item === 'Luci' ? '#00bcd4' :
            item === 'Temperatura' ? '#ff9800' :
            item === 'Energia' ? '#4caf50' :
            '#2196f3'
          "></i>
        </div>
        <div class="title">{{ item }}</div>
        <div class="value" *ngIf="item === 'Luci'">{{ lightsOn() }} On</div>
        <div class="value" *ngIf="item === 'Temperatura'">{{ currentTemperature }}Â°C</div>
        <div class="value" *ngIf="item === 'Energia'">4.5 kWh</div>
        <div class="value" *ngIf="item === 'Telecamere'">{{ camsOn() }} On</div>
      </div>

      <div class="card-expanded" *ngIf="item === 'Luci'">
        <div class="lights-row">
          <span class="label">Tutte le luci</span>
          <label class="switch" (click)="$event.stopPropagation()">
            <input type="checkbox" [checked]="areAllLightsOn()" (change)="toggleAllLights()" />
            <span class="slider"></span>
          </label>
        </div>
      </div>

      <div class="card-expanded" *ngIf="item === 'Temperatura'">
        <div class="temperature-row">
          <button class="action-btn small" (click)="changeTemperature(-1)">âˆ’</button>
          <span class="temp-value">{{ currentTemperature }}Â°C</span>
          <button class="action-btn small" (click)="changeTemperature(1)">+</button>
        </div>
      </div>
    </div>
  </aside>

  <div class="map-wrapper">
    <div class="map-container">
      <img src="assets/planimetria_modern_5.png" alt="Mappa" class="map-image" />

      <div class="device-status" *ngIf="loadingDevice">
        <div class="spinner"></div>
        <p>Verifica connessione...</p>
      </div>

      <div *ngFor="let device of devices"
        class="device-icon"
        [class.on]="device.status === 'on'"
        [class]="device.icon"
        [style.top.%]="device.top"
        [style.left.%]="device.left"
        [attr.data-tooltip]="device.name + ' (' + device.status + ')'"
        (click)="handleDeviceClick(device)">
      </div>

      <!-- ðŸ”¹ Popup camera -->
      <div *ngIf="selectedCamera" class="camera-popup show">
        <div class="popup-header">
          <span>{{ selectedCamera.name }}</span>
          <button class="close-btn" (click)="closeCamera()"><i class="fas fa-times"></i></button>
        </div>
        <div class="popup-content">
          <video *ngIf="selectedCamera.streamUrl" [src]="selectedCamera.streamUrl" autoplay controls></video>
          <div *ngIf="!selectedCamera.streamUrl" class="video-placeholder">
            <i class="fas fa-video-slash"></i>
            <p>Nessun flusso video disponibile</p>
          </div>
        </div>
      </div>

      <!-- ðŸ”¹ Popup serranda -->
      <div *ngIf="selectedShutter" class="camera-popup show">
        <div class="popup-header">
          <span>{{ selectedShutter.name }}</span>
          <button class="close-btn" (click)="closeShutterPopup()"><i class="fas fa-times"></i></button>
        </div>

        <div class="popup-content shutter-popup">
          <div class="shutter-slider">
            <div class="shutter-value">{{ selectedShutter.shutter_position }}%</div>
            <input type="range" orient="vertical" min="0" max="100" step="1"
              [ngModel]="selectedShutter.shutter_position"
              (ngModelChange)="onShutterInput($event)"
              (change)="setShutterPosition(selectedShutter)" />
          </div>
          <div class="shutter-buttons">
            <button class="action-btn" (click)="openShutter(selectedShutter)">Apri</button>
            <button class="action-btn" (click)="closeShutter(selectedShutter)">Chiudi</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<app-toast #toast></app-toast>
